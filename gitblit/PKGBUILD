# Maintainer: Julien Nicoulaud <julien.nicoulaud@gmail.com>
# Source: https://github.com/nicoulaj/archlinux-packages
pkgname=gitblit
pkgver=0.7.0
pkgrel=1
pkgdesc="Pure Java stack for managing, viewing, and serving Git repositories."
arch=(any)
url="http://gitblit.com"
license=(APACHE)
depends=('java-environment>=6' 'bash')
optdepends=('smtp-server:to enable mail notifications')
install=${pkgname}.install
changelog=Changelog
backup=("etc/${pkgname}/${pkgname}.properties"
		"etc/${pkgname}/users.properties"
		"etc/conf.d/${pkgname}")
source=("http://${pkgname}.googlecode.com/files/${pkgname}-${pkgver}.zip"
        "${pkgname}.conf.d"
        "${pkgname}.install"
        "${pkgname}.logrotate.d"
        "${pkgname}.rc.d"
        "${pkgname}.properties.patch")
md5sums=('9746d69bfcffe41bbe68066c8af5fa27'
         '411d09fb25d917937e4e20e49e0982b2'
         '60e9fbc5006f27a4a8ed0ba584907aed'
         '598c329cfe7817c4b7d1df91248dc881'
         '7940f1ed85d01901fd2c9a20f0357183'
         '9289570f831a93e323e90c886ab2b862')

build() {
  msg2 "Patch paths in ${pkgname}.properties..."
  cd "${srcdir}"
  patch -p0 -i ${pkgname}.properties.patch
}

package() {
  msg2 "Install Java livraries in /usr/share/java/${pkgname}..."
  install -Dm644 "${srcdir}/${pkgname}.jar" "${pkgdir}/usr/share/java/${pkgname}/${pkgname}.jar"

  msg2 "Install configuration files in /etc/${pkgname}..."
  install -dm755                                   "${pkgdir}/etc/${pkgname}"
  install -Dm644 "${srcdir}/${pkgname}.properties" "${pkgdir}/etc/${pkgname}/"
  install -Dm644 "${srcdir}/users.properties"      "${pkgdir}/etc/${pkgname}/"

  msg2 "Setup links to runtime resources in /var/lib/${pkgname}..."
  install -dm755                                  "${pkgdir}/var/lib/${pkgname}"
  ln -s /usr/share/java/${pkgname}/${pkgname}.jar "${pkgdir}/var/lib/${pkgname}/"
  ln -s /etc/${pkgname}/${pkgname}.properties     "${pkgdir}/var/lib/${pkgname}/"

  msg2 "Install daemon script in /etc/rc.d..."
  install -Dm755 "${srcdir}/${pkgname}.rc.d" "${pkgdir}/etc/rc.d/${pkgname}"

  msg2 "Install daemon conf file in /etc/conf.d..."
  install -Dm644 "${srcdir}/${pkgname}.conf.d" "${pkgdir}/etc/conf.d/${pkgname}"

  msg2 "Install logrotate configuration in /etc/logrotate.d..."
  install -Dm755 "${srcdir}/${pkgname}.logrotate.d" "${pkgdir}/etc/logrotate.d/${pkgname}"

  msg2 "Create logs directory at /var/log/${pkgname}..."
  install -dm755 "${pkgdir}/var/log/${pkgname}"

  msg2 "Install documentation resources in /usr/share/doc/${pkgname}..."
  install -Dm644 "${srcdir}/NOTICE" "${pkgdir}/usr/share/doc/${pkgname}/NOTICE"
  cp -a "${srcdir}"/docs/*          "${pkgdir}/usr/share/doc/${pkgname}/"

  msg2 "Install copyright resources in /usr/share/licenses/${pkgname}..."
  install -Dm644 "${srcdir}/LICENSE"     "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
  ln -s /usr/share/doc/${pkgname}/NOTICE "${pkgdir}/usr/share/licenses/${pkgname}/"
}
